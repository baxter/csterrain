<!DOCTYPE html>  <html> <head>   <title>generate_terrain.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               generate_terrain.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Generate realistic looking terrain using the <a href="http://en.wikipedia.org/wiki/Diamond-square_algorithm">diamond square algorithm</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">print</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>Generating a height map</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The height map is an array of numbers that describes the terrain. 
The height_map object contains a 'populate' method that uses the diamond
square algorithm to fill the 'map' property, an array of values.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">height_map = </span>	
	<span class="nv">get_cell: </span><span class="nf">(x, y) -&gt;</span>
		<span class="nx">@map</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span>

	<span class="nv">set_cell: </span><span class="nf">(x, y, v) -&gt;</span>
		<span class="nx">@map</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span> <span class="o">||=</span> <span class="nx">v</span>
	</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The populate method fills the height map with values. It takes a size
parameter which must be 2<sup>n</sup> + 1 in order to work.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">populate: </span><span class="nf">(@size, @low_value=0, @high_value=255) -&gt;</span>
		<span class="vi">@mid_value = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">((</span><span class="nx">@low_value</span> <span class="o">+</span> <span class="nx">@high_value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span>
		
		<span class="nv">centre_cell = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">@size</span><span class="err">/2)</span>
		</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Create an empty 2D array, @size Ã— @size.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="vi">@map = </span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">@size</span><span class="p">]</span>
			<span class="mi">0</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">@size</span><span class="p">]</span>
		</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The diamond square algorithm needs the four corner values to be set, so 
set them to a reasonable value.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@map</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@map</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nx">@size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@map</span><span class="p">[</span><span class="nx">@size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@map</span><span class="p">[</span><span class="nx">@size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="nx">@size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@mid_value</span>
		</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Start the diamond square algorithm, passing in the area that should 
be processed. Since we're just starting, the region is the whole array.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@diamond_square</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">@size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">@mid_value</span> <span class="err">/ 2)</span>
	</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The diamond square algorithm works on a particular region in 2 steps:</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">diamond_square: </span><span class="nf">(left, top, right, bottom, base_height) -&gt;</span>
		<span class="nv">x_centre = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
		<span class="nv">y_centre = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
		</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <ul>
<li>The <strong>diamond</strong> step populates the centre point by averaging the 
values at the four corners and adding or subtracting a random amount.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		
		<span class="nv">height = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="nx">base_height</span> <span class="o">*</span> <span class="mi">2</span>
		
		<span class="nv">centre_point_value = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span>
			<span class="p">(</span>
				<span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span> <span class="o">+</span>
				<span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span> <span class="o">+</span>
				<span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">)</span> <span class="o">+</span>
				<span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">)</span>
			<span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
		<span class="p">)</span> <span class="o">-</span> <span class="nx">height</span>
		
		<span class="nx">@set_cell</span><span class="p">(</span><span class="nx">x_centre</span><span class="p">,</span> <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">centre_point_value</span><span class="p">)</span>
		</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <ul>
<li>The <strong>square</strong> step populates the North, South, East and West points 
by averaging the North West and North East values, the South East and 
South East values, etc.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		
		<span class="nx">@set_cell</span><span class="p">(</span><span class="nx">x_centre</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span>      <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span>  <span class="nx">top</span><span class="p">)</span>    <span class="o">+</span> <span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span>   <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="nx">@set_cell</span><span class="p">(</span><span class="nx">x_centre</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">,</span>   <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span>  <span class="nx">bottom</span><span class="p">)</span> <span class="o">+</span> <span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="nx">@set_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span>     <span class="nx">y_centre</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span>  <span class="nx">top</span><span class="p">)</span>    <span class="o">+</span> <span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span>  <span class="nx">bottom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="nx">@set_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span>    <span class="nx">y_centre</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span>    <span class="o">+</span> <span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Once the centre point and the four side points are populated then, 
provided there are no smaller regions left, split the current region
into four smaller regions and perform the diamond square algorithm
on them. </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nx">right</span> <span class="o">-</span> <span class="nx">left</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
			<span class="nv">base_height = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">base_height</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span> <span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.75</span>
			
			<span class="nx">@diamond_square</span> <span class="nx">left</span><span class="p">,</span>     <span class="nx">top</span><span class="p">,</span>      <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">base_height</span>
			<span class="nx">@diamond_square</span> <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span>      <span class="nx">right</span><span class="p">,</span>    <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">base_height</span>
			<span class="nx">@diamond_square</span> <span class="nx">left</span><span class="p">,</span>     <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">,</span>   <span class="nx">base_height</span>
			<span class="nx">@diamond_square</span> <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">right</span><span class="p">,</span>    <span class="nx">bottom</span><span class="p">,</span>   <span class="nx">base_height</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Generate the height map with an array size of 33. The height map size needs to be 2<sup>n</sup> + 1.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">height_map</span><span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>

<span class="nx">print</span> <span class="s2">&quot;  var terrain = &quot;</span> <span class="o">+</span> 
	<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">height_map</span><span class="p">.</span><span class="nx">map</span><span class="p">).</span>
	<span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;[[&quot;</span><span class="p">,</span><span class="s2">&quot;[\n    [&quot;</span><span class="p">).</span>
	<span class="nx">replace</span><span class="p">(</span><span class="sr">/\],\[/g</span><span class="p">,</span><span class="s2">&quot;],\n    [&quot;</span><span class="p">).</span>
	<span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;]]&quot;</span><span class="p">,</span><span class="s2">&quot;]\n  ]&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 