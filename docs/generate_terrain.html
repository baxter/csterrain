<!DOCTYPE html>  <html> <head>   <title>generate_terrain.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               generate_terrain.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Generate realistic looking terrain using the 'diamond square' algorithm
and then draw the output using canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">print</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">HeightMap</span>
	<span class="nv">constructor: </span><span class="nf">(@size, @low_value, @high_value) -&gt;</span>
		<span class="vi">@mid_value = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">((</span><span class="nx">@low_value</span> <span class="o">+</span> <span class="nx">@high_value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span>
				
		<span class="nv">centre_cell = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">@size</span> <span class="err">/ 2)</span>
		
		<span class="vi">@map = </span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">@size</span><span class="p">]</span>
			<span class="mi">0</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">@size</span><span class="p">]</span>
		
		<span class="nx">@map</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@map</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nx">@size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@map</span><span class="p">[</span><span class="nx">@size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@map</span><span class="p">[</span><span class="nx">@size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="nx">@size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@mid_value</span>

		<span class="nx">@populate</span><span class="p">()</span>
			
	<span class="nv">get_cell: </span><span class="nf">(x, y) -&gt;</span>
		<span class="nx">@map</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span>
	
	<span class="nv">set_cell: </span><span class="nf">(x, y, v) -&gt;</span>
		<span class="nx">@map</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span> <span class="o">||=</span> <span class="nx">v</span>
	
	<span class="nv">populate: </span><span class="nf">() -&gt;</span>
		<span class="nx">@diamond_square</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">@size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">@mid_value</span> <span class="err">/ 2)</span>
	
	<span class="nv">diamond_square: </span><span class="nf">(left, top, right, bottom, base_height) -&gt;</span>
		<span class="nv">x_centre = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
		<span class="nv">y_centre = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

		<span class="nv">height = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="nx">base_height</span> <span class="o">*</span> <span class="mi">2</span>
		
		<span class="nv">centre_point_value = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span>
			<span class="p">(</span>
				<span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span> <span class="o">+</span>
				<span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span> <span class="o">+</span>
				<span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">)</span> <span class="o">+</span>
				<span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">)</span>
			<span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
		<span class="p">)</span> <span class="o">-</span> <span class="nx">height</span>
		
		<span class="nx">@set_cell</span><span class="p">(</span><span class="nx">x_centre</span><span class="p">,</span> <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">centre_point_value</span><span class="p">)</span>
		</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>North</p>

<p>South</p>

<p>East</p>

<p>West</p>             </td>             <td class="code">               <div class="highlight"><pre>		
		<span class="nx">@set_cell</span><span class="p">(</span><span class="nx">x_centre</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span>      <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span>    <span class="o">+</span> <span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span>   <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="nx">@set_cell</span><span class="p">(</span><span class="nx">x_centre</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">,</span>   <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">)</span> <span class="o">+</span> <span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="nx">@set_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span>     <span class="nx">y_centre</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span>    <span class="o">+</span> <span class="nx">@get_cell</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="nx">@set_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span>    <span class="nx">y_centre</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span>   <span class="o">+</span> <span class="nx">@get_cell</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="nx">right</span> <span class="o">-</span> <span class="nx">left</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
			<span class="nv">base_height = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">base_height</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span> <span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.75</span>

			<span class="nx">@diamond_square</span> <span class="nx">left</span><span class="p">,</span>     <span class="nx">top</span><span class="p">,</span>      <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">base_height</span>
			<span class="nx">@diamond_square</span> <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span>      <span class="nx">right</span><span class="p">,</span>    <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">base_height</span>
			<span class="nx">@diamond_square</span> <span class="nx">left</span><span class="p">,</span>     <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">,</span>   <span class="nx">base_height</span>
			<span class="nx">@diamond_square</span> <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">right</span><span class="p">,</span>    <span class="nx">bottom</span><span class="p">,</span>   <span class="nx">base_height</span>

<span class="nv">h = </span><span class="k">new</span> <span class="nx">HeightMap</span><span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

<span class="nx">print</span> <span class="s2">&quot;  var terrain = &quot;</span> <span class="o">+</span> 
	<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">map</span><span class="p">).</span>
	<span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;[[&quot;</span><span class="p">,</span><span class="s2">&quot;[\n    [&quot;</span><span class="p">).</span>
	<span class="nx">replace</span><span class="p">(</span><span class="sr">/\],\[/g</span><span class="p">,</span><span class="s2">&quot;],\n    [&quot;</span><span class="p">).</span>
	<span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;]]&quot;</span><span class="p">,</span><span class="s2">&quot;]\n  ]&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 