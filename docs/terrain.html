<!DOCTYPE html>  <html> <head>   <title>terrain.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               terrain.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Generate realistic looking terrain using the 'diamond square' algorithm
and then draw the output using canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">print</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The dimensions of the height map array should be <code>2^n+1</code> square.
The terrain size is 1 less than the height_map</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">height_map_size = </span><span class="mi">33</span>
<span class="nv">terrain_size    = </span><span class="nx">height_map_size</span> <span class="o">-</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The lowest and highest points that the height map may contain</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">low_point  = </span><span class="mi">0</span>
<span class="nv">high_point = </span><span class="mi">255</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Initialise an empty 2D array.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">height_map = </span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">height_map_size</span><span class="p">]</span>
	<span class="mi">0</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">height_map_size</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>Populate the height map</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The 'diamond square' algorithm requires the four corner points of the 
region that it is currently processing to be set first.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">height_map</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">height_map</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">height_map</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="nx">height_map</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mi">127</span>

<span class="nx">height_map</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">64</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Given a height map and a region within that map populate the height map with values</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">populate_height_map = </span><span class="nf">(map, left, top, right, bottom, base_height=64) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Find the value for the centre point of the current region by averaging 
the value of the four corner points and adding or subtracting a random amount.
The size of this random amount should be proportional to the depth of the recursion.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">x_centre = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
	<span class="nv">y_centre = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
	
	<span class="nv">height = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span>
		<span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">base_height</span>
	<span class="p">)</span>
	
	<span class="nx">map</span><span class="p">[</span><span class="nx">x_centre</span><span class="p">][</span><span class="nx">y_centre</span><span class="p">]</span> <span class="o">||=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span>
		<span class="p">(</span>
			<span class="nx">map</span><span class="p">[</span><span class="nx">left</span><span class="p">][</span><span class="nx">top</span><span class="p">]</span>     <span class="o">+</span>
			<span class="nx">map</span><span class="p">[</span><span class="nx">right</span><span class="p">][</span><span class="nx">top</span><span class="p">]</span>    <span class="o">+</span>
			<span class="nx">map</span><span class="p">[</span><span class="nx">left</span><span class="p">][</span><span class="nx">bottom</span><span class="p">]</span>  <span class="o">+</span>
			<span class="nx">map</span><span class="p">[</span><span class="nx">right</span><span class="p">][</span><span class="nx">bottom</span><span class="p">]</span>
		<span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">-</span> <span class="nx">height</span>
	<span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Find the value of the North, South, West and East points by averaging the 
appropriate corner values.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">map</span><span class="p">[</span><span class="nx">x_centre</span><span class="p">][</span><span class="nx">top</span><span class="p">]</span>    <span class="o">||=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">map</span><span class="p">[</span><span class="nx">left</span><span class="p">][</span><span class="nx">top</span><span class="p">]</span>    <span class="o">+</span> <span class="nx">map</span><span class="p">[</span><span class="nx">right</span><span class="p">][</span><span class="nx">top</span><span class="p">]</span>   <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
	<span class="nx">map</span><span class="p">[</span><span class="nx">x_centre</span><span class="p">][</span><span class="nx">bottom</span><span class="p">]</span> <span class="o">||=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">map</span><span class="p">[</span><span class="nx">left</span><span class="p">][</span><span class="nx">bottom</span><span class="p">]</span> <span class="o">+</span> <span class="nx">map</span><span class="p">[</span><span class="nx">right</span><span class="p">][</span><span class="nx">bottom</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
	<span class="nx">map</span><span class="p">[</span><span class="nx">left</span><span class="p">][</span><span class="nx">y_centre</span><span class="p">]</span>   <span class="o">||=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">map</span><span class="p">[</span><span class="nx">left</span><span class="p">][</span><span class="nx">top</span><span class="p">]</span>    <span class="o">+</span> <span class="nx">map</span><span class="p">[</span><span class="nx">left</span><span class="p">][</span><span class="nx">bottom</span><span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
	<span class="nx">map</span><span class="p">[</span><span class="nx">right</span><span class="p">][</span><span class="nx">y_centre</span><span class="p">]</span>  <span class="o">||=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">map</span><span class="p">[</span><span class="nx">right</span><span class="p">][</span><span class="nx">top</span><span class="p">]</span>   <span class="o">+</span> <span class="nx">map</span><span class="p">[</span><span class="nx">right</span><span class="p">][</span><span class="nx">bottom</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="nx">right</span> <span class="o">-</span> <span class="nx">left</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
		<span class="nv">base_height = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">base_height</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span> <span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.75</span>
		
		<span class="nx">populate_height_map</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span>     <span class="nx">top</span><span class="p">,</span>      <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">base_height</span>
		<span class="nx">populate_height_map</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span>      <span class="nx">right</span><span class="p">,</span>    <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">base_height</span>
		<span class="nx">populate_height_map</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span>     <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">,</span>   <span class="nx">base_height</span>
		<span class="nx">populate_height_map</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">x_centre</span><span class="p">,</span> <span class="nx">y_centre</span><span class="p">,</span> <span class="nx">right</span><span class="p">,</span>    <span class="nx">bottom</span><span class="p">,</span>   <span class="nx">base_height</span>

<span class="nx">populate_height_map</span><span class="p">(</span><span class="nx">height_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>

<span class="nx">print</span> <span class="s1">&#39;var terrain = &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">height_map</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 